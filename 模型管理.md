### 上传模型库

- **URL**: `/thing/twin/model/uploadModelLibraries`
- **方法**: POST
- **请求体:**
  - `files`: 包含一个或多个模型文件的 ZIP 压缩文件，以及每个模型的相关信息。
- **请求头:**
  - `Content-Type`: multipart/form-data
- **响应**:

  ```json
  {
    "code": -1,
    "data": true,
    "success": true
  }
  ```

### 模型转换

（<a href="./assets/file/浙江电科院.zip" target="_blank">模型转换插件包下载</a>）

**配置参数**

```
#模型转换工具的路径地址
uino.mode-convertor-url=/uino/convertor
#模型转换工具的配置文件
uino.mode-convertor-config=/uino/convertor/conf/convertor_config.toml
```

**配置文件**

```
将convertor_config.toml配置文件放到resources下面
```

**示例代码**

```
String sourcePath = "C:\\Users\\fbx";//源模型文件夹路径
String targetPath = "C:\\Users\\gltf";//转换完成后文件夹路径
String convertType = "gltf";//要转换成什么格式
ConvertInfo convertInfo = ModelConvertProvider.getProvider().convertModel(sourcePath, targetPath, convertType);
```

**convertCode**

```
0:"转换成功"
111: "不支持的导出类型",
112: "加载转换配置失败",
113: "没有发现支持导入的文件类型",
114: "发现有多个支持导入的文件",
115: "导入文件失败，需查看转换日志排查",
116: "不支持的转换配置",
117: "面数超过上线",
118: "面数为0",
119: "导出写文件失败",
120: "创建导出文件夹失败",
121: "拷贝贴图文件失败",
122: "修复贴图路径失败",
123: "写bundle json失败",
124: "写index json失败",
125: "NotSupportOlderFormatFbx",
126: "NotSupportNewerFormatFbx",
127: "InputFolderNotFound",
128: "InputIsNotFolder",
129: "FailedToConvertFbxVersion",
130: "NotFoundBinFromGltfFile",
131: "InvalidFaceIndex",
132: "FailedToImportFbxWithFBXSDK",
133: "FailedToExportFbxWithFBXSDK",
```

### 查询模型库

- **URL**: `/thing/twin/model/queryModelPage`
- **方法**: POST
- **请求体:**
  - `pageNum`: 当前页码，用于分页查询。
  - `pageSize`: 每页显示的模型数量。
  - `totalRows`: 满足查询条件的总模型数量。
  - `sizeOpts`: 用于选择每页显示的模型数量的选项。
  - `orders`: 指定排序方式，例如 `MODIFY_TIME DESC` 表示按照修改时间降序排列。
  - `searchType`: 搜索类型，2 表示按关键词搜索。
  - `searchKeyword`: 搜索关键词。
- **请求头:**
  - `Content-Type`: application/json; charset=UTF-8
- **响应**:

  ```json
  {
    "code": -1,
    "data": {
      "data": [
        {
          "animation": [],
          "code": "b5c359462a434128_gltf",
          "faces": 19877,
          "fileSize": 2469902,
          "formatFileSize": "2.36MB",
          "id": 3619326552201495,
          "modelTime": "2024-01-10 10:19:12",
          "modifyTime": 20240110101913,
          "preview": "/thing/rsm/3619326552200188/product/modelItems/webgl/b5c359462a434128_gltf.jpg",
          "size": [879.0026245117188, 254.73901367187503, 389.25973320007324],
          "title": "model (3)",
          "url": "/thing/rsm/3619326552200188/product/modelItems/webgl/b5c359462a434128_gltf/",
          "userModels": []
        },
        {
          "animation": [],
          "code": "B723E9E1B279467EBC9433D30D35F683",
          "faces": 12,
          "fileSize": 12442,
          "formatFileSize": "12.15KB",
          "id": 3619326552201291,
          "modifyTime": 20240109134150,
          "preview": "/thing/rsm/3619326552200188/product/modelItems/webgl/B723E9E1B279467EBC9433D30D35F683.jpg",
          "size": [1.0, 1.0, 1.0],
          "title": "万能方盒子_万能方盒子",
          "url": "/thing/rsm/3619326552200188/product/modelItems/webgl/B723E9E1B279467EBC9433D30D35F683/",
          "userModels": []
        }
      ],
      "pageNum": 1,
      "pageSize": 20,
      "totalPages": 1,
      "totalRows": 2
    },
    "success": true
  }
  ```

### 模型信息

**示例代码**

```
String sourcePath = "C:\\Users\\gltf\\model.gltf";
ModelInfo modelInfo = ModelConvertProvider.getProvider().getModelInfo(sourcePath);
```

**返回参数**

```
faces：面数
vertices：点数
textures：纹理
solidMsg：长宽高
animations：动画
```

### GIM 转换

**配置参数**

```
#GIM转换工具的路径地址
uino.gim-convertor-url=http://127.0.0.1:8080/gim-boot/api/gim
```

**示例代码**

```
File gimFile = new File(/gim/大瑶220KV变电站初步设计-5.7.gim");
String exportOption = "1";
String level = "2";
String models = "[{\"id\":\"9da35040-2af7-4666-a188-27c9e23bf733\",\"type\":1}]";
JSONArray modelsArr =  JSONUtil.parseArray(models);
File tjs = GimConvertProvider.getProvider().convertTjs(gimFile, exportOption, level, modelsArr);
```

**入参说明**

```
gimfile：gim文件的路径，在转换时会在gim文件所在的文件夹下面生成一些转过换成中的文件，并最后组装成tjs
exportOption：导出模型类型   1：整站导出单个  2：整站导出多个
level：要合并的层级   1：F1  2：F2  3：F3   4:F4
models：数组 ，要合并的节点
```

**出参说明**

```
tjs：最后生成的tjs文件，一般是与gim文件在同一个目录下面
```

> **备注**：有的 gim 转换时间比较长，建议异步调用

#### 转 GLTF

**示例代码**

```
File gimFile = new File(/gim/大瑶220KV变电站初步设计-5.7.gim");
String exportOption = "1";
String level = "2";
String models = "[{\"id\":\"9da35040-2af7-4666-a188-27c9e23bf733\",\"type\":1}]";
JSONArray modelsArr =  JSONUtil.parseArray(models);
File file = GimConvertProvider.getProvider().convertTjs(gimFile, exportOption, level, modelsArr, "gltf");
```

**出参说明**

```
file：转换完成的模型文件，一般是与gim文件在同一个目录下面，是一个zip包
```

#### 转 FBX

**示例代码**

```
File gimFile = new File(/gim/大瑶220KV变电站初步设计-5.7.gim");
String exportOption = "1";
String level = "2";
String models = "[{\"id\":\"9da35040-2af7-4666-a188-27c9e23bf733\",\"type\":1}]";
JSONArray modelsArr =  JSONUtil.parseArray(models);
File file = GimConvertProvider.getProvider().convertTjs(gimFile, exportOption, level, modelsArr, "fbx");
```

**出参说明**

```
file：转换完成的模型文件，一般是与gim文件在同一个目录下面，是一个zip包
```

#### gim 转换相关接口

#### 导入 gim 文件，启动解析任务

**URL**

```
POST  /loadGim?biz=upload
```

请求参数 multipart/form-data

| 字段名 |                                         | 类型 | 是否必须 |
| ------ | --------------------------------------- | ---- | -------- |
| file   | file://F:\GIM\同里 220KV 变电站工程.gim | File | 是       |

**返回值**

```
{
    "success": true,
    "message": "",
    "code": 200,
    "result": {
        "task_id": "1777958733951811586",
        "task_type": 1,
        "file_path": "/gim/upload/同里220KV变电站工程_1712733369569.gim",
        "root_id": null,
        "create_by": null,
        "create_time": "2024-04-10 15:16:09",
        "update_by": null,
        "update_time": null,
        "task_status": 1,
        "task_time": null,
        "is_delete": 0,
        "progress_value": null,
        "node_id_list": null,
        "progress_message": null,
        "project_name": null
    },
    "timestamp": 1712733370070
}
```

#### 根据 Id 查询任务状态(解析或者导出都可以使用)

**返回结果中，task_type == 1 为文件解析任务 task_type == 2 为导出任务**

**URL**

```
GET  /getTaskById?taskId=1777958733951811586
```

**返回值**

```
{
    "success": true,
    "message": "",
    "code": 200,
    "result": {
        "task_id": "1777958733951811586",
        "task_type": 1,
        "file_path": "/gim/upload/同里220KV变电站工程_1712733369569.gim",
        "root_id": "b29f19b3-f139-491c-9f60-2a9d0b08d3af",
        "create_by": null,
        "create_time": "2024-04-10 15:16:09",
        "update_by": null,
        "update_time": null,
        "task_status": 1,
        "task_time": null,
        "is_delete": 0,
        "progress_value": null,
        "node_id_list": null,
        "progress_message": null,
        "project_name": null
    },
    "timestamp": 1712733370070
}
```

#### 启动导出 GLTF 任务

**URL**

```
GET  /exportGLTF?projectId=b29f19b3-f139-491c-9f60-2a9d0b08d3af&option=1
```

**入参说明**

projectId：为上面接口中返回的 root_id

option：

option == 1 ： 导出整站 单个 gltf

option == 2： 导出整站 多个 gltf

option == 3： 导出合并节点 每个节点生成一个 gltf

**返回值**

```
{
    "success": true,
    "message": "string",
    "code": 0,
    "result": {
        "taskId": "string",
        "taskType": "string",
        "filePath": "string",
        "rootId": "string",
        "taskStatus": "string",
        "progressMessage": "string",
        "progressValue": "string",
        "createTime": "string"
    }
}
```

#### 启动导出 FBX 任务

**URL**

```
GET  /exportFBX?projectId=b29f19b3-f139-491c-9f60-2a9d0b08d3af&option=1
```

**入参说明**

projectId：为上面接口中返回的 root_id

option：

option == 1 ： 导出整站 单个 gltf

option == 2： 导出整站 多个 gltf

option == 3： 导出合并节点 每个节点生成一个 gltf

**返回值**

```
{
    "success": true,
    "message": "string",
    "code": 0,
    "result": {
        "taskId": "string",
        "taskType": "string",
        "filePath": "string",
        "rootId": "string",
        "taskStatus": "string",
        "progressMessage": "string",
        "progressValue": "string",
        "createTime": "string"
    }
}
```

#### 获取 gim 项目结构树

**URL**

```
GET  /getJSON?projectId=b29f19b3-f139-491c-9f60-2a9d0b08d3af
```

**返回值**

```
{
    "success": true,
    "message": "string",
    "code": 0,
    "result": {
        "id": "string",
        "name": "string",
        "fileId": "string",
        "fileType": 0,
        "isMerge": 0,
        "parent": "string",
        "children": {},
        "attribute": {
            "key": "string",
            "enName": "string",
            "value": {},
            "group": "string"
        }
    }
}
```

#### 下载已输出的全部文件

**URL**

```
GET  /getGLTF?file=result/1779866802210353153.zip
```

**入参说明**

file：文本，模型路径

**入参代码实例**

```
String file = "result/" + taskId + ".zip";
```

返回值 InputStream 文件流

#### 根据项目 Id 分页查询导出任务状态

**URL**

```
GET  /getExportTaskProgress?projectId=b29f19b3-f139-491c-9f60-2a9d0b08d3af&pageNo=1&pageSize=10
```

**返回值**

task_status 为 99 ，代表任务完成
progress_value 为导出进度值

```
{
	"success": true,
	"message": "",
	"code": 200,
	"result": {
		"records": [
			{
				"task_id": "1779759265007939585",
				"task_type": 2,
				"file_path": null,
				"root_id": "2a95a0d6-9445-48a7-8425-5ac28d7a7f8f",
				"create_by": null,
				"create_time": "2024-04-15 14:30:50",
				"update_by": null,
				"update_time": null,
				"task_status": 1,
				"task_time": null,
				"is_delete": 0,
				"progress_value": null,
				"node_id_list": 10,
				"progress_message": null,
				"project_name": "赤岸220KV变电站"
			}
		],
		"total": 1,
		"size": 10,
		"current": 1,
		"orders": [],
		"optimize_count_sql": true,
		"search_count": true,
		"optimize_join_of_count_sql": true,
		"count_id": null,
		"max_limit": null,
		"count": 10,
		"page": 1,
		"pages": 1
	},
	"timestamp": 1713163272849
}
```

#### 节点合并

**URL**

```
POST  /tProjectinfo/fileMerge
```

**请求参数** application/json

| 字段名     | 说明                                | 类型   | 是否必须 |
| ---------- | ----------------------------------- | ------ | -------- |
| project_id | root_id 的值                        | String | 是       |
| level      | 指定需要合并的层级 可选值： 1 2 3 4 | String | 否       |
| models     | 数组 ，存放需要合并的节点           | 数组   | 否       |
| id         | 当前模型节点的 id                   | String |          |
| type       |                                     | String |          |

注：两个参数同时提供，models 更优先， 忽略 level

**入参示例**

```
{
    "models": [
        {
            "id": "string",
            "type": "string"
        }
    ],
    "level": "string",
    "project_id": "string"
}
```

**返回值**

task_status 为 99 ，代表任务完成
progress_value 为导出进度值

```
{
    "success": true,
    "message": "string",
    "code": 0,
    "result": "string"
}
```

#### 查询导入任务状态列表

**URL**

```
GET  /getImportTaskProgress
```

**请求参数 multipart/form-data**

| 字段名   | 说明                 | 类型    | 是否必须 |
| -------- | -------------------- | ------- | -------- |
| pageNo   | 页数                 | Integer | 是       |
| pageSize | 每页的条数           | Integer | 是       |
| column   | 排序字段             | String  | 否       |
| order    | asc/desc             | String  | 否       |
| name     | 项目名称（模糊查询） | String  | 否       |

**返回值 **

```json
{
  "success": true,
  "message": "",
  "code": 200,
  "result": {
    "records": [
      {
        "id": "92f3375c-39cc-4540-913e-4a85584203f3",
        "name": "project",
        "projectGuid": null,
        "projectName": "project",
        "voltage": null,
        "designphase": null,
        "engineerType": null,
        "gurrentType": null,
        "loopNumber": null,
        "linelength": null,
        "isOpticalfibre": null,
        "type": 1,
        "createTime": "2024-07-17 17:51:57",
        "childrenList": null,
        "showName": "赤岸220KV变电站",
        "parseProgress": 100,
        "parseMessage": "解析完成",
        "buildProgress": 100,
        "buildMessage": "2074/0/2074",
        "visualProgress": 100,
        "visualMessage": "64/0/64"
      },
      {
        "id": "fa50adb3-f64e-44c5-abb4-081be7047f7c",
        "name": "project",
        "projectGuid": null,
        "projectName": "project",
        "voltage": null,
        "designphase": null,
        "engineerType": null,
        "gurrentType": null,
        "loopNumber": null,
        "linelength": null,
        "isOpticalfibre": null,
        "type": 1,
        "createTime": "2024-07-11 17:34:30",
        "childrenList": null,
        "showName": "赤岸220KV变电站",
        "parseProgress": 100,
        "parseMessage": "解析完成",
        "buildProgress": 100,
        "buildMessage": "2074/0/2074",
        "visualProgress": 100,
        "visualMessage": "64/0/64"
      }
    ],
    "total": 95,
    "size": 10,
    "current": 1,
    "orders": [],
    "optimize_count_sql": true,
    "search_count": true,
    "optimize_join_of_count_sql": true,
    "count_id": null,
    "max_limit": null,
    "count": 10,
    "page": 1,
    "page_no": 1,
    "pages": 10
  },
  "timestamp": 1721628461749
}
```

### GIM 预览

源码下载：<a href="./assets/file/gim-ui-2.zip" target="_blank">gim-ui 源码</a>

> 使用了，**D3Viewer** 组件进行GIM查看

#### 1、概述

本组件按照 VUE3 框架开发，用于模型的显示、缩放、移动、旋转、选择等操作

#### 2、使用方式

| 引入组件 | import D3Viewer from './components/D3Viewer.vue';                                                                |
| -------- | ---------------------------------------------------------------------------------------------------------------- |
| 使用组件 | <D3Viewer :projectId="projectId" ref="d3viewer" @select="onModelSelected" @cancleSelect="onModelCancleSelect" /> |

#### 3、函数列表及使用示例

| 函数名         | 参数           | 描述                                                                                                                                              | 示例                                                                                                                                                                                                                                                                                                                        |
| -------------- | -------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| setVisible     | nodelList bVal | 功能：设置模型节点是否可见，支持批量操作 参数 1：nodelList 指定要显示或隐藏的模型 Id 列表 参数 2： bVal 设置模型是否可见 (true 可见 false 不可见) | let modIdList = []; for (const node of selectNodes.value) { let nodeType = node.etype; if (nodeType == 'F1System' \|\| nodeType == 'F2System') { let ret = await getF3Nodes({ nodeId: node.id }); modIdList = modIdList.concat(ret); } else { modIdList.push(node.id); } } d3viewer.value.setVisible(modIdList, false);     |
| setSelected    | nodelList      | 功能：设置模型节点为选中状态，支持批量操作 参数 1：nodelList 指定要选中高亮的模型 Id 列表                                                         | let modIdList = []; for (const node of selectNodes.value) { let nodeType = node.etype; if (nodeType == 'F1System' \|\| nodeType == 'F2System') { let ret = await getF3Nodes({ nodeId: node.id }); modIdList = modIdList.concat(ret); } else { modIdList.push(node.id); } } d3viewer.value.setSelected(modIdList, false);    |
| cancleSelected | 无参数         | 功能：设置所有模型为非选中状态                                                                                                                    | let modIdList = []; for (const node of selectNodes.value) { let nodeType = node.etype; if (nodeType == 'F1System' \|\| nodeType == 'F2System') { let ret = await getF3Nodes({ nodeId: node.id }); modIdList = modIdList.concat(ret); } else { modIdList.push(node.id); } } d3viewer.value.cancleSelected(modIdList, false); |
| setCenter      | nodelList      | 功能：设置模型节点为拉近居中显示，支持批量操作 参数 1：nodelList 指定要拉近居中显示的模型 Id 列表                                                 | let modIdList = []; for (const node of selectNodes.value) { let nodeType = node.etype; if (nodeType == 'F1System' \|\| nodeType == 'F2System') { let ret = await getF3Nodes({ nodeId: node.id }); modIdList = modIdList.concat(ret); } else { modIdList.push(node.id); } } d3viewer.value.setCenter(modIdList, false);      |

#### 4、事件

| 名称         | 说明                                                   |
| ------------ | ------------------------------------------------------ |
| select       | 模型区域选中模型后会发出此消息，可自行编写响应函数     |
| cancleSelect | 模型区域取消选中模型后会发出此消息，可自行编写响应函数 |

### 删除模型

- **URL**: `/thing/twin/model/deleteModels`
- **方法**: POST
- **请求体:**
  - `ids`: 要删除的模型 ID 列表，以数组形式提供。
- **请求头:**
  - `Content-Type`: application/json; charset=UTF-8
- **响应**:
  ```json
  {
    "code": -1,
    "data": [],
    "success": true
  }
  ```

**说明:**

- `ids`: 要删除的模型 ID 列表，以数组形式提供。

### 下载模型库

- **URL**: `/thing/twin/model/downLoadModelLibrary`
- **方法**: POST
- **请求体**:
  - `ids`: 要下载的模型 ID 列表，以数组形式提供。
- **请求头**:
  - `Content-Type`: application/json; charset=UTF-8
- **响应**: 下载模型库文件(二进制)

### 模型预览

#### `加密的gltf模型格式预览`

<a id="model" href="./assets/html/previewModel.html" style="font-size:12px;color:#ff8000;display: inline-block"  target="_blank">点击进行模型预览（附带生成预览图）</a>
（预览插件下载：<a href="./assets/vendor/thing.min-V1.4.27.js" target="_blank">thing.min-V1.4.27.js</a>）

```vue
<script setup lang="ts">
import { toBinaryData } from '@/utils/tools';
import { message } from 'ant-design-vue';
import { ref, onMounted, onBeforeUnmount, computed } from 'vue';

const props = defineProps<{
  url: string;
  type: string;
  info: number[];
  from: string;
}>();

let app: THING.App;
// 当前模型
let model: THING.Thing;
// 帧
const fps = ref<number>();
// const tempThing = ref();
// eslint-disable-next-line no-undef
let timer: number | NodeJS.Timeout | null = null;
// 动画列表
const animationList = ref<Array<{ name: string; status: boolean }>>([]);

// 模型基本信息
const modelBaseInfo = computed(() => {
  return [
    {
      name: 'fps',
      value: fps.value || 0,
      unit: '',
    },
    ...props.info.map((item, index) => {
      const msg = ['长', '宽', '高'];
      return {
        name: msg[index],
        value: item.toFixed(2),
        unit: 'm',
      };
    }),
  ];
});
// 模型样式
const modelStyle = ref({
  enablePan: false,
  enableZoom: false,
  background: '#e3e3e3',
});

type IModelOption = {
  name: string;
  value: boolean;
  icon: string;
  action: (item: IModelOption) => void;
  status: boolean;
};
// 模型选型 截图 坐标轴 线性化
const modelOptions = ref<Array<IModelOption>>([
  {
    name: '重置',
    value: false,
    icon: 'icon-reset',
    action: reset,
    status: true,
  },
  {
    name: '生成预览图',
    value: false,
    icon: 'icon-camera',
    action: screenshot,
    status: props.from === 'check',
  },
  {
    name: '坐标系',
    value: false,
    icon: 'icon-coordinate-axis',
    action: setCoordinateAxis,
    status: true,
  },
  {
    name: '包围盒',
    icon: 'icon-bounding-box',
    value: false,
    action: setBoundingBox,
    status: true,
  },
  {
    name: '线框',
    icon: 'icon-wireframe',
    value: false,
    action: wireframe,
    status: true,
  },
]);

const emit = defineEmits(['screenshot', 'update:animations']);
/**
 * @description 截图
 */
function screenshot() {
  const base64Image = (app as THING.App).captureScreenshotToImage(
    381,
    198,
    'png',
    0.5
  );
  emit('screenshot', {
    base64: base64Image,
    binary: toBinaryData(base64Image),
  });
}
/**
 * @description 设置坐标系
 */
function setCoordinateAxis(item: { value: boolean }) {
  item.value = !item.value;
  if (model) {
    model.style.axisHelper = item.value;
    disableObjChildAxis(model);
  }
}
/**
 * @description 设置包围盒
 */
function setBoundingBox(item: IModelOption) {
  item.value = !item.value;
  model.showBoundingBox(item.value);
  if (item.value) {
    model.style.boundingBoxColor = '#ff8000';
  }
}
/**.value
 * @description 设置线框
 */
function wireframe(item: IModelOption) {
  item.value = !item.value;
  model.style.wireframe = item.value;
}

/**
 * @description 隐藏子模型的坐标系
 * @param obj 模型
 */
function disableObjChildAxis(obj: THING.BaseObject) {
  if (obj.children && obj.children.length) {
    obj.children.forEach((item: THING.BaseObject) => {
      item.style.axisHelper = false;
      disableObjChildAxis(item);
    });
  }
}
/**
 * @Description: 模型加载
 */
function previewModel() {
  // 预览公司自己的模型
  app = new THING.App({ container: 'div-model', background: '#e3e3e3' });
  // 关闭默认的鼠标右键平移操作
  app.camera.enablePan = false;
  // 关闭默认的鼠标滚轮缩放操作
  app.camera.enableZoom = false;

  app.create({
    type: 'Thing',
    id: 'exp', // 物体 id
    name: '预览模型', // 物体名称
    url: props.url, // 模型地址
    position: [0, 0, 0], // 在世界坐标系下的位置
    complete: ({ object }: THING.BaseObject) => {
      model = object;
      // tempThing.value = object;
      flyToModel();
      animationList.value = object?.animationNames.map((name: string) => {
        return { name, status: false };
      });
    },
  });
}
/**
 * @Description: 定位到模型
 * @return {*}
 */
function flyToModel() {
  app.camera.flyTo({
    object: model,
    radiusFactor: 1.5,
    time: 1000,
  });
}

function reset() {
  // 重置模型样式
  modelStyle.value = {
    enablePan: false,
    enableZoom: false,
    background: '#e3e3e3',
  };
  flyToModel();
  app.camera.enablePan = false;
  app.camera.enableZoom = false;
  changeBackground();
}
/**
 * @Description: 播放模型动画
 * @param {*} name 动画名称
 * @return {*}
 */
function playAnimation(item: { name: string; status: boolean }) {
  const hasPlaying = animationList.value.filter((item) => item.status).length;
  if (hasPlaying) {
    message.info('有正在执行的动画');
    return;
  }
  item.status = true;
  model?.playAnimation({
    name: item.name,
    speed: 1,
    reverse: false,
    complete: function () {
      item.status = false;
    },
  });
}
/**
 * @Description: 改变模型预览的背景色
 * @return {*}
 */
function changeBackground() {
  app && (app.background = modelStyle.value.background);
}
// defineExpose({ thingObject: tempThing });
onMounted(() => {
  setTimeout(async () => {
    previewModel();
    if (!timer) {
      timer = setInterval(() => {
        fps.value = (app && app.renderStates.fps) as number;
      }, 1000);
    } else {
      clearInterval(timer);
    }
  }, 1000);
});

onBeforeUnmount(() => {
  app && app.query('*').destroyAll();
  timer && clearInterval(timer);
});
</script>
<template>
  <div class="preview-model-box">
    <!-- 基本信息 -->
    <div class="data-box">
      <div v-for="(item, index) in modelBaseInfo" :key="index">
        <span class="name">{{ item.name }}：</span>
        <span class="value">{{ item.value }}</span>
        <span class="unit">{{ item.unit }}</span>
      </div>
    </div>
    <div class="scene" id="div-model"></div>
    <!-- 动画列表 -->
    <div class="animation-box">
      动画列表：
      <span v-show="!animationList.length">暂无动画</span>
      <a-button
        v-for="(item, index) in animationList"
        :key="index"
        :class="{ active: item.status }"
        @click="playAnimation(item)"
      >
        {{ item.name }}
      </a-button>
    </div>
    <!-- 操作按钮 -->
    <div class="action-box">
      <div v-for="item in modelOptions" :key="item.name">
        <a-tooltip
          class="box-item"
          effect="dark"
          :content="item.name"
          placement="top"
          v-if="item.status"
        >
          <template #title>{{ item.name }}</template>
          <div
            class="iconfont"
            :class="[item.icon, { active: item.value }]"
            @click="item.action(item)"
          ></div>
        </a-tooltip>
      </div>
    </div>
    <!-- 样式修改 -->
    <div class="model-style">
      <div class="box-item">
        <input
          type="color"
          v-model="modelStyle.background"
          @change="changeBackground"
        />
        背景色
      </div>
      <div class="box-item">
        <a-checkbox
          v-model:checked="modelStyle.enablePan"
          @change="app.camera.enablePan = modelStyle.enablePan"
          >平移</a-checkbox
        >
      </div>
      <div class="box-item">
        <a-checkbox
          v-model:checked="modelStyle.enableZoom"
          @change="app.camera.enableZoom = modelStyle.enableZoom"
          >缩放</a-checkbox
        >
      </div>
    </div>
  </div>
</template>
<style scoped lang="less">
.preview-model-box {
  width: 100%;
  height: 100%;
  position: relative;
  border-radius: 5px;

  .data-box {
    position: absolute;
    left: 32px;
    top: 28px;
    z-index: 1;
    width: 120px;
    height: 100px;
    border: 1px rgba(0, 0, 0, 0.14) solid;
    padding: 5px 5px;
    border-radius: 5px;

    .name {
      display: inline-block;
      text-align: center;
      min-width: 50px;
      text-align: right;
    }

    .value {
      font-weight: 500;
      color: var(--factory-primary-color);
      font-size: 14px;
      font-weight: 700;
      min-width: 50px;
    }
    .unit {
      margin-left: 5px;
    }
  }

  .scene {
    width: 100%;
    height: 100%;
  }

  .animation-box {
    width: 100%;
    height: 30px;
    position: absolute;
    bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;

    .ant-btn {
      margin: 0px 2px;
    }

    .active {
      color: var(--factory-primary-color);
      border-color: var(--factory-primary-color);
    }
  }

  .action-box {
    position: absolute;
    right: 32px;
    top: 32px;
    font-size: 24px;
    display: flex;

    align-items: center;
    justify-content: space-between;

    .iconfont {
      font-size: 20px;
      margin: 0 5px;
      cursor: pointer;

      &:hover {
        color: var(--factory-primary-color);
      }
    }

    .active {
      color: var(--factory-primary-color);
    }
  }

  .model-style {
    position: absolute;
    left: 32px;
    bottom: 28px;
    z-index: 1;
    width: 120px;
    height: 100px;
    border: 1px rgba(0, 0, 0, 0.14) solid;
    padding: 15px 15px 5px 15px;
    border-radius: 5px;
    .box-item {
      display: flex;
    }
    input[type='color'] {
      width: 20px;
      height: 20px;
      appearance: none;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 5px;
    }
  }
}
</style>
```

```js
/**
 * 图片转二进制流
 * @param data
 */
export function toBinaryData(data: string) {
  const binaryString = atob(data.split(',')[1]);
  const binaryData = new Uint8Array(binaryString.length);
  for (let i = 0; i < binaryString.length; i++) {
    binaryData[i] = binaryString.charCodeAt(i);
  }
  return binaryData;
}
```

#### `标准模型预览(obj,gltf,fbx)`

（预览插件下载：<a href="./assets/vendor/PreviewModelTool.ts" target="_blank">PreviewModelTool.ts</a>）

```vue
<script setup lang="ts">
import { PreviewModelTool } from '@/utils/PreviewModelTool';
import { toBinaryData, sleep } from '@/utils/tools';
import { message } from 'ant-design-vue';
import { ref, onMounted, onBeforeUnmount, computed } from 'vue';

const props = defineProps<{
  url: string;
  type: string;
  info: number[];
  from: string;
}>();
// 获取dom
const sceneContainer = ref<HTMLElement | null>(null);
const previewModelTool = new PreviewModelTool();
// 帧
const fps = ref<number>();

type IModelOption = {
  name: string;
  value: boolean;
  icon: string;
  action: (item: IModelOption) => void;
  status: boolean;
};
// 模型选型 截图 坐标轴 线性化
const modelOptions = ref<Array<IModelOption>>([
  {
    name: '重置',
    value: false,
    icon: 'icon-reset',
    action: reset,
    status: true,
  },
  {
    name: '生成预览图',
    value: false,
    icon: 'icon-camera',
    action: screenshot,
    status: props.from === 'check',
  },
  {
    name: '坐标系',
    value: false,
    icon: 'icon-coordinate-axis',
    action: setCoordinateAxis,
    status: true,
  },
  {
    name: '包围盒',
    icon: 'icon-bounding-box',
    value: false,
    action: setBoundingBox,
    status: true,
  },
  {
    name: '线框',
    icon: 'icon-wireframe',
    value: false,
    action: wireframe,
    status: true,
  },
]);

// 加载状态
const loading = ref<boolean>(true);

// eslint-disable-next-line no-undef
let timer: number | NodeJS.Timeout | null = null;
const emit = defineEmits(['screenshot', 'update:animations']);
// 动画列表
const animationList = ref<Array<{ name: string; status: boolean }>>([]);
// 模型基本信息
const modelBaseInfo = computed(() => {
  return [
    {
      name: 'fps',
      value: fps.value || 0,
      unit: '',
    },
    ...props.info.map((item, index) => {
      const msg = ['长', '宽', '高'];
      return {
        name: msg[index],
        value: item.toFixed(2),
        unit: 'm',
      };
    }),
  ];
});
// 模型样式
const modelStyle = ref({
  enablePan: false,
  enableZoom: false,
  background: '#e3e3e3',
});
/**
 * @description 截图
 */
function screenshot() {
  const dataURL = previewModelTool.screenshot(381, 198);

  emit('screenshot', {
    base64: dataURL,
    binary: toBinaryData(dataURL),
  });
}
/**
 * @description  加载模型
 * @param   type 模型类型
 */
async function loadModel(type: string) {
  await sleep(2000);
  try {
    if (type === 'obj') {
      await previewModelTool.loadObjModel(props.url);
    } else if (type === 'fbx') {
      await previewModelTool.loadFbxModel(props.url);
    } else if (type === 'gltf') {
      await previewModelTool.loadGltfModel(props.url);
    }
    let arr = [];
    for (const key in previewModelTool.animationActions) {
      arr.push({ name: key, status: false });
    }
    animationList.value = arr;
    // emit('update:animations', arr)
  } catch (err) {
    console.log('err:', err);
  }
}
/**
 * @description 设置坐标系
 */
function setCoordinateAxis(item: IModelOption) {
  item.value = !item.value;
  previewModelTool.axesHelper.visible = item.value;
}
/**
 * @description 设置包围盒
 */
function setBoundingBox(item: IModelOption) {
  item.value = !item.value;
  previewModelTool.boundingBoxHelper.visible = item.value;
}
/**
 * @description 设置线框
 */
function wireframe(item: IModelOption) {
  item.value = !item.value;
  previewModelTool.setWireframe(item.value);
}

/**
 * @description 播放动画
 * @param item 包含动画名称和状态
 */
const playAnimation = async (item: { name: string; status: boolean }) => {
  const hasPlaying = animationList.value.filter((item) => item.status).length;
  if (hasPlaying) {
    message.info('有正在执行的动画');
    return;
  }
  item.status = true;
  await previewModelTool.playAnimation(item.name);
  // 动画播放完毕，修改状态
  item.status = false;
};
/**
 * @Description: 改变背景色
 * @return {*}
 */
function changeBackground() {
  previewModelTool.changeBackground(modelStyle.value.background);
}
/**
 * @Description: 重置
 * @return {*}
 */
function reset() {
  // 重置模型样式
  modelStyle.value = {
    enablePan: false,
    enableZoom: false,
    background: '#e3e3e3',
  };
  previewModelTool.flyTo();
  previewModelTool.orbitControl.enablePan = false;
  previewModelTool.orbitControl.enableZoom = false;
  changeBackground();
}

onMounted(() => {
  if (!timer) {
    timer = setInterval(() => {
      fps.value = previewModelTool.fps;
    }, 1000);
  } else {
    clearInterval(timer);
  }
  setTimeout(() => {
    previewModelTool.init(sceneContainer.value as HTMLElement);
    loadModel(props.type).then(() => {
      loading.value = false;
      // 关闭平移和缩放
      previewModelTool.orbitControl.enablePan = false;
      previewModelTool.orbitControl.enableZoom = false;
    });
  }, 1000);
});

onBeforeUnmount(() => {
  timer && clearInterval(timer);
  previewModelTool.destroyModel();
  previewModelTool.pause();
});

defineExpose({
  previewModelTool,
});
</script>
<template>
  <div class="preview-model-box">
    <div class="loading-box" v-show="loading">
      <a-spin />
    </div>
    <!-- 基本信息 -->
    <div class="data-box">
      <div v-for="(item, index) in modelBaseInfo" :key="index">
        <span class="name">{{ item.name }}：</span>
        <span class="value">{{ item.value }}</span>
        <span class="unit">{{ item.unit }}</span>
      </div>
    </div>
    <div ref="sceneContainer" class="scene"></div>
    <div class="animation-box">
      动画列表：
      <span v-show="!animationList.length">暂无动画</span>
      <a-button
        v-for="(item, index) in animationList"
        :key="index"
        :class="{ active: item.status }"
        @click="playAnimation(item)"
      >
        {{ item.name }}
      </a-button>
    </div>
    <!-- 操作按钮 -->
    <div class="action-box">
      <div v-for="item in modelOptions" :key="item.name">
        <a-tooltip
          class="box-item"
          effect="dark"
          :content="item.name"
          placement="top"
          v-if="item.status"
        >
          <template #title>{{ item.name }}</template>
          <div
            class="iconfont"
            :class="[item.icon, { active: item.value }]"
            @click="item.action(item)"
          ></div>
        </a-tooltip>
      </div>
    </div>
    <!-- 样式修改 -->
    <div class="model-style">
      <div class="box-item">
        <input
          type="color"
          v-model="modelStyle.background"
          @change="changeBackground"
        />
        背景色
      </div>
      <div class="box-item">
        <a-checkbox
          v-model:checked="modelStyle.enablePan"
          @change="
            previewModelTool.orbitControl.enablePan = modelStyle.enablePan
          "
          >平移</a-checkbox
        >
      </div>
      <div class="box-item">
        <a-checkbox
          v-model:checked="modelStyle.enableZoom"
          @change="
            previewModelTool.orbitControl.enableZoom = modelStyle.enableZoom
          "
          >缩放</a-checkbox
        >
      </div>
    </div>
  </div>
</template>
<style scoped lang="less">
.preview-model-box {
  width: 100%;
  height: 100%;
  position: relative;
  border-radius: 5px;

  .loading-box {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    width: 100%;
    height: 100%;
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .data-box {
    position: absolute;
    left: 32px;
    top: 28px;
    z-index: 1;
    width: 120px;
    height: 100px;
    border: 1px rgba(0, 0, 0, 0.14) solid;
    padding: 5px 5px;
    border-radius: 5px;

    .name {
      display: inline-block;
      text-align: center;
      min-width: 50px;
      text-align: right;
    }

    .value {
      font-weight: 500;
      color: var(--factory-primary-color);
      font-size: 14px;
      font-weight: 700;
      min-width: 50px;
    }
    .unit {
      margin-left: 5px;
    }
  }

  .scene {
    width: 100%;
    height: 100%;
  }

  .animation-box {
    width: 100%;
    height: 30px;
    position: absolute;
    bottom: 10px;
    display: flex;
    align-items: center;
    justify-content: center;

    .ant-btn {
      margin: 0px 2px;
    }

    .active {
      color: var(--factory-primary-color);
      border-color: var(--factory-primary-color);
    }
  }

  .action-box {
    position: absolute;
    right: 32px;
    top: 32px;
    font-size: 24px;
    display: flex;

    align-items: center;
    justify-content: space-between;

    .iconfont {
      font-size: 20px;
      margin: 0 5px;
      cursor: pointer;

      &:hover {
        color: var(--factory-primary-color);
      }
    }

    .active {
      color: var(--factory-primary-color);
    }
  }

  .model-style {
    position: absolute;
    left: 32px;
    bottom: 28px;
    z-index: 1;
    width: 120px;
    height: 100px;
    border: 1px rgba(0, 0, 0, 0.14) solid;
    padding: 15px 15px 5px 15px;
    border-radius: 5px;
    .box-item {
      display: flex;
    }
    input[type='color'] {
      width: 20px;
      height: 20px;
      appearance: none;
      border: 1px solid #ccc;
      border-radius: 5px;
      margin-right: 5px;
    }
  }
}
</style>
```
